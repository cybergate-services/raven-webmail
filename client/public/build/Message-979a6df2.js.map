{"version":3,"file":"Message-979a6df2.js","sources":["../../node_modules/svelte-material-icons/ArrowLeft.svelte","../../src/comp/Attachments/Attachments.svelte","../../src/comp/Pages/Message/Message.svelte","../../src/lib/router/routes/Message.svelte"],"sourcesContent":["<script>\n  export let size = \"1em\";\n  export let width = size;\n  export let height = size;\n  export let color = \"currentColor\";\n  export let viewBox = \"0 0 24 24\";\n</script>\n\n<svg width=\"{width}\" height=\"{height}\" viewBox=\"{viewBox}\"><path d=\"M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z\" fill=\"{color}\"/></svg>","<style>\n  x-count {\n    position: absolute;\n    top: 0;\n    right: 0;\n    font-size: 0.6em;\n    color: #fff;\n    background: var(--pc);\n    border-radius: 50%;\n    width: 1.4em;\n    height: 1.4em;\n    line-height: 1.4em;\n    text-align: center;\n  }\n\n  x-item {\n    display: flex;\n    flex-direction: row;\n    align-items: center;\n    padding-inline-end: 0.5em;\n  }\n\n  img {\n    flex: none;\n    height: 1.5em;\n    width: 1.5em;\n    margin-inline-end: 1em;\n  }\n</style>\n\n<script>\n  export let mailbox;\n  export let message;\n  export let attachments;\n\n  import Paperclip from \"svelte-material-icons/Paperclip.svelte\";\n  import {Ripple, Menuitem} from \"svelte-mui\";\n  import Menu from \"svelte-mui/src/Menu.svelte\";\n  import {url} from \"lib@fileIcons.js\";\n\n  import {getContext} from \"svelte\";\n  const {trans} = getContext(\"app\");\n</script>\n\n<Menu origin=\"top right\">\n  <x-action slot=\"activator\" class=\"btn-dark\" data-tooltip=\"Archivos adjuntos\">\n    <Paperclip/>\n    <Ripple/>\n    {#if attachments.length}\n      <x-count>{attachments.length}</x-count>\n    {/if}\n  </x-action>\n\n  {#each attachments as file}\n    <Menuitem href=\"/download/{$mailbox.id}/{$message.id}/{file.id}?filename={encodeURIComponent(file.filename)}\" download target=\"_blank\">\n      <x-item>\n        <img src={url(file.filename)} alt=\"\">\n        {file.filename}\n      </x-item>\n    </Menuitem>\n  {/each}\n</Menu>","<style>\n  x-tab-content {\n    position: relative;\n    flex: 1;\n    display: flex;\n    flex-direction: column;\n    overflow: auto;\n    padding: 2em 3em;\n  }\n\n  x-message-title {\n    font-size: 1.5em;\n    font-weight: 600;\n    min-height: auto;\n  }\n\n  x-message-content {\n    margin-top: 3em;\n    min-height: auto;\n    margin-bottom: 2em;\n  }\n\n  x-message-content :global(a) {\n    color: blue;\n    text-decoration: underline;\n  }\n\n  x-message-content :global(a:visited) {\n    color: blueviolet;\n  }\n  \n  x-message-info {\n    flex: none;\n    display: flex;\n    flex-direction: column;\n    margin-top: 2em;\n  }\n\n  x-message-from, x-message-to, x-message-date {\n    padding: 0.25em 0;\n  }\n\n  x-message-content {\n    flex-grow: 1;\n  }\n\n  .from-main{\n    font-weight: 600;\n  }\n  \n</style>\n\n<script>\n  import {writable} from \"../../../lib/store\";\n  import {getContext} from \"svelte\";\n\n  import Tab from \"../Main.svelte\";\n  import Topbar from \"../ActionBar.svelte\";\n  //import Content from \"/comp/Tab/Content.svelte\";\n\n  import Delete from \"svelte-material-icons/DeleteOutline.svelte\";\n  import MarkUnseen from \"svelte-material-icons/EmailOutline.svelte\";\n  //import MarkSeen from \"svelte-material-icons/EmailOpenOutline.svelte\";\n  //import MarkUnseen from \"svelte-material-icons/EmailMultipleOutline.svelte\";\n  //import MarkUnseen from \"svelte-material-icons/EmailMarkAsUnread.svelte\";\n  import MarkSeen from \"svelte-material-icons/EmailOpenOutline.svelte\";\n  import MarkSpam from \"svelte-material-icons/AlertDecagramOutline.svelte\";\n  import UnMarkSpam from \"svelte-material-icons/EmailCheckOutline.svelte\";\n  import Resend from \"svelte-material-icons/EmailSendOutline.svelte\";\n  import Reply from \"svelte-material-icons/EmailReceiveOutline.svelte\";\n  import GoBack from \"svelte-material-icons/ArrowLeft.svelte\";\n\n  import {Ripple} from \"svelte-mui\";\n\n  import {sanitize} from \"../../../lib/sanitize\";\n\n  import {create} from \"../../Compose/compose\";\n  \n  export let mailbox;\n  export let message;\n  export let scroll;\n\n  const handleScroll = e => scroll.set(e.target.scrollTop);\n\n  import * as messages from \"../../../lib/client/messages\"\n  import * as mailboxes from \"../../../lib/client/mailboxes\"\n\n  let isJunk = mailboxes.junk === mailbox;\n  let isTrash = mailboxes.trash === mailbox;\n  let isDraft = mailboxes.drafts === mailbox;\n  let isSent = mailboxes.sent === mailbox;\n\n  const onetime = fn => {\n    let updating = false;\n    return async () => {\n      if (updating) return;\n      updating = true;\n      try {\n        await fn();\n      } catch(e) {\n        throw e;\n      } finally {\n        updating = false;\n      }\n    }\n  }\n\n  const seen = onetime(async () => {\n    await messages.updateSeen($mailbox.id, [$message.id], !$message.seen);\n    message.update(m => ({...m, seen: !m.seen}))\n  })\n\n  const spam = onetime(async () => {\n    await messages.markAsSpam($mailbox.id, [$message.id], !isJunk);\n    location.hash = `#!/mailbox/${$mailbox.id}`;\n  })\n\n  const del = onetime(async () => {\n    await messages.del($mailbox.id, [$message.id]);\n    location.hash = `#!/mailbox/${$mailbox.id}`;\n  })\n\n  const reply = onetime(async () => {\n    const $draft = await messages.createReply($mailbox.id, $message.id);\n    create(writable($draft));\n  })\n\n  const forward = onetime(async () => {\n    const $draft = await messages.createForward($mailbox.id, $message.id);\n    create(writable($draft));\n  })\n\n  import MoveTo from \"../MoveTo.svelte\";\n  const gotoBox = () => setTimeout((() => location.hash = `#!/mailbox/${$mailbox.id}`), 250);\n\n  import Attachments from \"comp@Attachments/Attachments.svelte\";\n\n  const {locale: l} = getContext(\"app\");\n  export let locale = $l;\n</script>\n\n<svelte:head>\n  <title>{$message.subject}</title>\n</svelte:head>\n\n<Tab>\n  <Topbar scrolled={$scroll !== 0}>\n    <x-action-group>\n      <a class=\"x-action btn-dark\" href=\"#!/mailbox/{$mailbox.id}\" data-tooltip={locale.actions.backToMailbox}>\n        <GoBack />\n        <Ripple />\n      </a>\n    </x-action-group>\n\n    <x-action-group>\n      <x-action \n        class=\"btn-dark\"\n        data-tooltip={$message.seen ? locale.actions.markAsUnread : locale.actions.markAsRead}\n        on:click={seen}\n      >\n        <Ripple />\n        {#if $message.seen}\n          <MarkUnseen />\n        {:else}\n          <MarkSeen />\n        {/if}\n      </x-action>\n\n      {#if isJunk}\n        <x-action class=\"btn-dark\" data-tooltip={locale.actions.unMarkAsSpam} on:click={spam}>\n          <UnMarkSpam />\n          <Ripple />\n        </x-action>\n      {:else if !isDraft && !isSent && !isTrash}\n        <x-action class=\"btn-dark\" data-tooltip={locale.actions.markAsSpam} on:click={spam}>\n          <MarkSpam />\n          <Ripple />\n        </x-action>\n      {/if}\n\n      <x-action class=\"btn-dark\" data-tooltip={\n          isTrash ? locale.actions.deletePermanently :\n          isDraft ? locale.actions.discardDrafts :\n          locale.actions.delete\n      } on:click={del}>\n        <Delete />\n        <Ripple />\n      </x-action>\n    </x-action-group>\n\n    <x-action-group>\n      <x-action class=\"btn-dark\" data-tooltip={locale.actions.forward} on:click={forward}>\n        <Resend />\n        <Ripple />\n      </x-action>\n\n      {#if !isDraft && !isSent}\n        <x-action class=\"btn-dark\" data-tooltip={locale.actions.reply} on:click={reply}>\n          <Reply />\n          <Ripple />\n        </x-action>\n      {/if}\n    </x-action-group>\n\n    <x-action-group>\n      <MoveTo {mailbox} selection={writable([message])} on:moved={gotoBox} tooltip={locale.actions.moveTo} />\n    </x-action-group>\n\n    {#if $message.attachments && $message.attachments.length}\n      <x-action-group>\n        <Attachments {mailbox} {message} attachments={$message.attachments} tooltip={locale.actions.attachments} />\n      </x-action-group>\n    {/if}\n  </Topbar>\n\n  <x-tab-content on:scroll={handleScroll}>\n    <x-message-title>{$message.subject}</x-message-title>\n    <x-message-info>\n\n      {#if $message.from}\n        <x-message-from>       \n          {#if $message.from.name}\n            {locale.message.labels.from}\n            <span class=\"from-main\">{$message.from.name}</span>\n            {\"<\"}{$message.from.address}{\">\"}\n          {:else}\n            {locale.message.labels.from}\n            <span class=\"from-main\">\n              {$message.from.address} \n            </span>\n          {/if}\n        </x-message-from>\n      {/if}\n      \n      {#if $message.to}\n        <x-message-to>\n          {locale.message.labels.to} {$message.to.map(to => {\n              return `<${to.address}>`\n            }).join(\", \")}\n        </x-message-to>\n      {/if}\n      \n      {#if $message.date}\n        <x-message-date>\n          {locale.message.labels.date} {new Date($message.date).toLocaleString()}\n        </x-message-date>\n      {/if}\n    </x-message-info>\n\n    <x-message-content>\n      {#if $message.html && $message.html.length}\n        {@html sanitize($message.html.join(\"\"))}\n      {:else if $message.text && $message.text.trim()}\n        <pre>{$message.text}</pre>\n      {/if}\n    </x-message-content>\n\n  </x-tab-content>\n</Tab>","<script context=\"module\">\n  import {writable} from \"../../../lib/store\";\n  import {user} from \"../../../lib/client/client\";\n  import * as mailboxes from \"../../../lib/client/mailboxes\";\n  import * as messages from \"../../../lib/client/messages\";\n\n  export async function preload($page) {\n    \n    if ( !user.get() ) {\n      return this.redirect(\"#!/login\");\n    }\n\n    const mailbox = await mailboxes.get($page.params.mailbox);\n    \n    if (mailbox == null) {\n      return this.redirect(\"#!/\");\n    }\n\n    try {\n      const $message = await messages.get($page.params.mailbox, $page.params.message);\n      const message = writable($message);\n      const scroll = writable(0);\n      return { mailbox, message, scroll };\n\n    } catch(e) {\n      this.redirect(`#!/mailbox/${mailbox.get().id}`);\n    }\n  }\n</script>\n\n<script>\n  import Message from \"../../../comp/Pages/Message/Message.svelte\";\n  //import Page from \"../../comp/Page.svelte\";\n\n  export let mailbox;\n  export let message;\n  export let scroll;\n</script>\n\n<Message {mailbox} {message} {scroll} />"],"names":["ctx","size","width","height","color","viewBox","length","filename","url","id","encodeURIComponent","mailbox","message","attachments","trans","getContext","actions","markAsSpam","unMarkAsSpam","seen","reply","writable","moveTo","backToMailbox","markAsUnread","markAsRead","deletePermanently","discardDrafts","delete","forward","from","name","labels","address","to","map","join","date","Date","toLocaleString","text","sanitize","html","subject","trim","scroll","isJunk","mailboxes.junk","isTrash","mailboxes.trash","isDraft","mailboxes.drafts","isSent","mailboxes.sent","onetime","fn","updating","e","messages.updateSeen","$mailbox","$message","update","m","spam","messages.markAsSpam","location","hash","del","messages.del","$draft","messages.createReply","create","messages.createForward","locale","l","$l","set","target","scrollTop","setTimeout","preload","$page","user","get","this","redirect","mailboxes.get","params","messages.get"],"mappings":"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"}