{"version":3,"file":"Message-faca4f42.js","sources":["../../node_modules/svelte-material-icons/ArrowLeft.svelte","../../src/comp/Attachments/Attachments.svelte","../../src/comp/Pages/Message/Message.svelte","../../src/lib/router/routes/Message.svelte"],"sourcesContent":["<script>\n  export let size = \"1em\";\n  export let width = size;\n  export let height = size;\n  export let color = \"currentColor\";\n  export let viewBox = \"0 0 24 24\";\n</script>\n\n<svg width=\"{width}\" height=\"{height}\" viewBox=\"{viewBox}\"><path d=\"M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z\" fill=\"{color}\"/></svg>","<style>\n  x-count {\n    position: absolute;\n    top: 0;\n    right: 0;\n    font-size: 0.6em;\n    color: #fff;\n    background: var(--pc);\n    border-radius: 50%;\n    width: 1.4em;\n    height: 1.4em;\n    line-height: 1.4em;\n    text-align: center;\n  }\n\n  x-item {\n    display: flex;\n    flex-direction: row;\n    align-items: center;\n    padding-inline-end: 0.5em;\n  }\n\n  img {\n    flex: none;\n    height: 1.5em;\n    width: 1.5em;\n    margin-inline-end: 1em;\n  }\n</style>\n\n<script>\n  export let mailbox;\n  export let message;\n  export let attachments;\n\n  import Paperclip from \"svelte-material-icons/Paperclip.svelte\";\n  import {Ripple, Menuitem} from \"svelte-mui\";\n  import Menu from \"svelte-mui/src/Menu.svelte\";\n  import {url} from \"lib@fileIcons.js\";\n</script>\n\n<Menu origin=\"top right\">\n  <x-action slot=\"activator\" class=\"btn-dark\" data-tooltip=\"Archivos adjuntos\">\n    <Paperclip/>\n    <Ripple/>\n    {#if attachments.length}\n      <x-count>{attachments.length}</x-count>\n    {/if}\n  </x-action>\n\n  {#each attachments as file}\n    <Menuitem href=\"/download/{$mailbox.id}/{$message.id}/{file.id}?filename={encodeURIComponent(file.filename)}\" download target=\"_blank\">\n      <x-item>\n        <img src={url(file.filename)} alt=\"\">\n        {file.filename}\n      </x-item>\n    </Menuitem>\n  {/each}\n</Menu>","<style>\n  x-tab-content {\n    position: relative;\n    flex: 1;\n    display: flex;\n    flex-direction: column;\n    overflow: auto;\n    padding: 2em 3em;\n  }\n\n  x-message-title {\n    font-size: 1.5em;\n    font-weight: 600;\n    min-height: auto;\n  }\n\n  x-message-content {\n    margin-top: 3em;\n    min-height: auto;\n    margin-bottom: 2em;\n  }\n\n  x-message-content :global(a) {\n    color: blue;\n    text-decoration: underline;\n  }\n\n  x-message-content :global(a:visited) {\n    color: blueviolet;\n  }\n  \n  x-message-info {\n    flex: none;\n    display: flex;\n    flex-direction: column;\n    margin-top: 2em;\n  }\n\n  x-message-from, x-message-to, x-message-date {\n    padding: 0.25em 0;\n  }\n\n  x-message-content {\n    flex-grow: 1;\n  }\n\n  .from-main{\n    font-weight: 600;\n  }\n  \n</style>\n\n<script>\n  import {writable} from \"../../../lib/store\";\n  import {getContext} from \"svelte\";\n\n  import Tab from \"../Main.svelte\";\n  import Topbar from \"../ActionBar.svelte\";\n  //import Content from \"/comp/Tab/Content.svelte\";\n\n  import Delete from \"svelte-material-icons/DeleteOutline.svelte\";\n  import MarkUnseen from \"svelte-material-icons/EmailOutline.svelte\";\n  //import MarkSeen from \"svelte-material-icons/EmailOpenOutline.svelte\";\n  //import MarkUnseen from \"svelte-material-icons/EmailMultipleOutline.svelte\";\n  //import MarkUnseen from \"svelte-material-icons/EmailMarkAsUnread.svelte\";\n  import MarkSeen from \"svelte-material-icons/EmailOpenOutline.svelte\";\n  import MarkSpam from \"svelte-material-icons/AlertDecagramOutline.svelte\";\n  import UnMarkSpam from \"svelte-material-icons/EmailCheckOutline.svelte\";\n  import Resend from \"svelte-material-icons/EmailSendOutline.svelte\";\n  import Reply from \"svelte-material-icons/EmailReceiveOutline.svelte\";\n  import GoBack from \"svelte-material-icons/ArrowLeft.svelte\";\n\n  import {Ripple} from \"svelte-mui\";\n\n  import {sanitize} from \"../../../lib/sanitize\";\n\n  import {create} from \"../../Compose/compose\";\n  \n  export let mailbox;\n  export let message;\n  export let scroll;\n\n  const handleScroll = e => scroll.set(e.target.scrollTop);\n\n  import * as messages from \"../../../lib/client/messages\"\n  import * as mailboxes from \"../../../lib/client/mailboxes\"\n\n  let isJunk = mailboxes.junk === mailbox;\n  let isTrash = mailboxes.trash === mailbox;\n  let isDraft = mailboxes.drafts === mailbox;\n  let isSent = mailboxes.sent === mailbox;\n\n  const onetime = fn => {\n    let updating = false;\n    return async () => {\n      if (updating) return;\n      updating = true;\n      try {\n        await fn();\n      } catch(e) {\n        throw e;\n      } finally {\n        updating = false;\n      }\n    }\n  }\n\n  const seen = onetime(async () => {\n    await messages.updateSeen($mailbox.id, [$message.id], !$message.seen);\n    message.update(m => ({...m, seen: !m.seen}))\n  })\n\n  const spam = onetime(async () => {\n    await messages.markAsSpam($mailbox.id, [$message.id], !isJunk);\n    location.hash = `#!/mailbox/${$mailbox.id}`;\n  })\n\n  const del = onetime(async () => {\n    await messages.del($mailbox.id, [$message.id]);\n    location.hash = `#!/mailbox/${$mailbox.id}`;\n  })\n\n  const reply = onetime(async () => {\n    const $draft = await messages.createReply($mailbox.id, $message.id);\n    create(writable($draft));\n  })\n\n  const forward = onetime(async () => {\n    const $draft = await messages.createForward($mailbox.id, $message.id);\n    create(writable($draft));\n  })\n\n  import MoveTo from \"../MoveTo.svelte\";\n  const gotoBox = () => setTimeout((() => location.hash = `#!/mailbox/${$mailbox.id}`), 250);\n\n  import Attachments from \"comp@Attachments/Attachments.svelte\"\n</script>\n\n<Tab>\n  <Topbar scrolled={$scroll !== 0}>\n    <x-action-group>\n      <a class=\"x-action btn-dark\" href=\"#!/mailbox/{$mailbox.id}\" data-tooltip=\"Volver al buzón\">\n        <GoBack />\n        <Ripple />\n      </a>\n    </x-action-group>\n\n    <x-action-group>\n      <x-action \n        class=\"btn-dark\"\n        data-tooltip={$message.seen ? \"Marcar como no leí­do\" : \"Marcar como leído\"}\n        on:click={seen}\n      >\n        <Ripple />\n        {#if $message.seen}\n          <MarkUnseen />\n        {:else}\n          <MarkSeen />\n        {/if}\n      </x-action>\n\n      {#if isJunk}\n        <x-action class=\"btn-dark\" data-tooltip=\"No es spam\" on:click={spam}>\n          <UnMarkSpam />\n          <Ripple />\n        </x-action>\n      {:else if !isDraft && !isSent && !isTrash}\n        <x-action class=\"btn-dark\" data-tooltip=\"Marcar como spam\" on:click={spam}>\n          <MarkSpam />\n          <Ripple />\n        </x-action>\n      {/if}\n\n      <x-action class=\"btn-dark\" data-tooltip={isDraft ? \"Descartar borrador\" : isTrash ? \"Eliminar definitivamente\" : \"Eliminar\"} on:click={del}>\n        <Delete />\n        <Ripple />\n      </x-action>\n    </x-action-group>\n\n    <x-action-group>\n      <x-action class=\"btn-dark\" data-tooltip=\"Reenviar\" on:click={forward}>\n        <Resend />\n        <Ripple />\n      </x-action>\n\n      {#if !isDraft && !isSent}\n        <x-action class=\"btn-dark\" data-tooltip=\"Responder\" on:click={reply}>\n          <Reply />\n          <Ripple />\n        </x-action>\n      {/if}\n    </x-action-group>\n\n    <x-action-group>\n      <MoveTo {mailbox} selection={writable([message])} on:moved={gotoBox}/>\n    </x-action-group>\n\n    {#if $message.attachments && $message.attachments.length}\n      <x-action-group>\n        <Attachments {mailbox} {message} attachments={$message.attachments} />\n      </x-action-group>\n    {/if}\n  </Topbar>\n\n  <x-tab-content on:scroll={handleScroll}>\n    <x-message-title>{$message.subject}</x-message-title>\n    <x-message-info>\n\n      {#if $message.from}\n        <x-message-from>       \n          {#if $message.from.name}\n            De: \n            <span class=\"from-main\">{$message.from.name}</span>\n            {\"<\"}{$message.from.address}{\">\"}\n          {:else}\n            De:\n            <span class=\"from-main\">\n              {$message.from.address} \n            </span>\n          {/if}\n        </x-message-from>\n      {/if}\n      \n      {#if $message.to}\n        <x-message-to>\n          Para: {$message.to.map(to => {\n              return `<${to.address}>`\n            }).join(\", \")}\n        </x-message-to>\n      {/if}\n      \n      {#if $message.date}\n        <x-message-date>\n          Enviado: {new Date($message.date).toLocaleString()}\n        </x-message-date>\n      {/if}\n    </x-message-info>\n\n    <x-message-content>\n      {#if $message.html && $message.html.length}\n        {@html sanitize($message.html.join(\"\"))}\n      {:else if $message.text && $message.text.trim()}\n        <pre>{$message.text}</pre>\n      {/if}\n    </x-message-content>\n\n  </x-tab-content>\n</Tab>","<script context=\"module\">\n  import {writable} from \"../../../lib/store\";\n  import {user} from \"../../../lib/client/client\";\n  import * as mailboxes from \"../../../lib/client/mailboxes\";\n  import * as messages from \"../../../lib/client/messages\";\n\n  export async function preload($page) {\n    \n    if ( !user.get() ) {\n      return this.redirect(\"#!/login\");\n    }\n\n    const mailbox = await mailboxes.get($page.params.mailbox);\n    \n    if (mailbox == null) {\n      return this.redirect(\"#!/\");\n    }\n\n    try {\n      const $message = await messages.get($page.params.mailbox, $page.params.message);\n      const message = writable($message);\n      const scroll = writable(0);\n      return { mailbox, message, scroll };\n\n    } catch(e) {\n      this.redirect(`#!/mailbox/${mailbox.get().id}`);\n    }\n  }\n</script>\n\n<script>\n  import Message from \"../../../comp/Pages/Message/Message.svelte\";\n  //import Page from \"../../comp/Page.svelte\";\n\n  export let mailbox;\n  export let message;\n  export let scroll;\n</script>\n\n<Message {mailbox} {message} {scroll} />"],"names":["ctx","size","width","height","color","viewBox","length","filename","url","id","encodeURIComponent","mailbox","message","attachments","seen","writable","from","name","address","to","map","join","Date","date","toLocaleString","text","sanitize","html","subject","trim","scroll","isJunk","mailboxes.junk","isTrash","mailboxes.trash","isDraft","mailboxes.drafts","isSent","mailboxes.sent","onetime","fn","updating","e","messages.updateSeen","$mailbox","$message","update","m","spam","messages.markAsSpam","location","hash","del","messages.del","reply","$draft","messages.createReply","create","forward","messages.createForward","set","target","scrollTop","setTimeout","preload","$page","user","get","this","redirect","mailboxes.get","params","messages.get"],"mappings":"qnBAQmJA,kBAAtIA,mBAAiBA,oBAAmBA,wDAAkGA,uBAAtIA,wBAAiBA,yBAAmBA,0DAPpCC,EAAO,gBACPC,EAAQD,aACRE,EAASF,YACTG,EAAQ,2BACRC,EAAU,wXCyCPL,KAAYM,oHAAZN,KAAYM,kGADnBN,KAAYM,2QAAZN,KAAYM,4OASZN,KAAKO,8EADIC,EAAIR,KAAKO,wKAATC,EAAIR,KAAKO,qCAClBP,KAAKO,0GAHiBP,KAASS,OAAKT,KAASS,OAAKT,KAAKS,gBAAcC,mBAAmBV,KAAKO,gLAAvEP,KAASS,OAAKT,KAASS,OAAKT,KAAKS,gBAAcC,mBAAmBV,KAAKO,mKAD7FP,0BAALM,sOAAKN,aAALM,+HAAAA,8DAAAA,omBAjDSK,qBACAC,yBACAC,80BCoKgEb,kZALNA,oOAqCjBA,KAASa,uLAATb,KAASa,iRA7ClDb,KAASc,kFAOXd,OAKMA,MAAYA,OAAWA,qGAmB5BA,OAAYA,oQAC8CA,kMAQnCe,GAAUf,yBAAqBA,cAGzDA,KAASa,aAAeb,KAASa,YAAYP,meAxDDN,KAASS,uFASxCT,KAASc,KAAO,wBAA0B,kEAuBjBd,KAAU,qBAAuBA,KAAU,2BAA6B,kbAtBrGA,mBAsB2HA,mBAO1EA,+CAvCdA,KAASS,4JASxCT,KAASc,KAAO,wBAA0B,yDAmCpDd,MAAYA,oEASWe,GAAUf,mBAGpCA,KAASa,aAAeb,KAASa,YAAYP,guBAavCN,KAASgB,KAAKC,wPAOdjB,KAASgB,KAAKE,gKAAdlB,KAASgB,KAAKE,+EALQlB,KAASgB,KAAKC,UACjCjB,KAASgB,KAAKE,6EAAnB,gBAA4B,uIADJlB,KAASgB,KAAKC,8BACjCjB,KAASgB,KAAKE,uGAYflB,KAASmB,GAAGC,QAEdC,KAAK,+IAFHrB,KAASmB,GAAGC,QAEdC,KAAK,iEAMIC,KAAKtB,KAASuB,MAAMC,mKAApBF,KAAKtB,KAASuB,MAAMC,sEAS9BxB,KAASyB,kFAATzB,KAASyB,wDAFRC,EAAS1B,KAAS2B,KAAKN,KAAK,yEAA5BK,EAAS1B,KAAS2B,KAAKN,KAAK,iFAnCrBrB,KAAS4B,0CAlEC,IAAZ5B,qDAqETA,KAASgB,cAeThB,KAASmB,YAQTnB,KAASuB,mCAQTvB,KAAS2B,MAAQ3B,KAAS2B,KAAKrB,kCAE1BN,KAASyB,OAAQzB,KAASyB,KAAKI,0hBArCnB7B,2CAjEI,IAAZA,yEAkEEA,KAAS4B,oBAGpB5B,KAASgB,4DAeThB,KAASmB,0DAQTnB,KAASuB,ojBANaJ,OACRA,EAAGD,6PAxMfP,qBACAC,oBACAkB,aAOPC,EAASC,IAAmBrB,EAC5BsB,EAAUC,IAAoBvB,EAC9BwB,EAAUC,IAAqBzB,EAC/B0B,EAASC,IAAmB3B,QAE1B4B,EAAUC,QACVC,GAAW,uBAETA,GACJA,GAAW,YAEHD,UACAE,SACAA,UAEND,GAAW,MAKX3B,EAAOyB,kBACLI,EAAoBC,EAASnC,IAAKoC,EAASpC,KAAMoC,EAAS/B,MAChEF,EAAQkC,OAAOC,QAAUA,EAAGjC,MAAOiC,EAAEjC,UAGjCkC,EAAOT,kBACLU,EAAoBL,EAASnC,IAAKoC,EAASpC,KAAMsB,GACvDmB,SAASC,mBAAqBP,EAASnC,KAGnC2C,EAAMb,kBACJc,EAAaT,EAASnC,IAAKoC,EAASpC,KAC1CyC,SAASC,mBAAqBP,EAASnC,KAGnC6C,EAAQf,kBACNgB,QAAeC,EAAqBZ,EAASnC,GAAIoC,EAASpC,IAChEgD,EAAO1C,EAASwC,MAGZG,EAAUnB,kBACRgB,QAAeI,EAAuBf,EAASnC,GAAIoC,EAASpC,IAClEgD,EAAO1C,EAASwC,6IA/CGb,GAAKZ,EAAO8B,IAAIlB,EAAEmB,OAAOC,iCAmDxBC,eAAkBb,SAASC,mBAAqBP,EAASnC,GAAO,waC3EhEuD,GAAQC,OAEtBC,EAAKC,aACFC,KAAKC,SAAS,kBAGjB1D,QAAgB2D,EAAcL,EAAMM,OAAO5D,YAElC,MAAXA,SACKyD,KAAKC,SAAS,iBAIfxB,QAAiB2B,EAAaP,EAAMM,OAAO5D,QAASsD,EAAMM,OAAO3D,gBAG9DD,QAAAA,EAASC,QAFFG,EAAS8B,GAEEf,OADZf,EAAS,UAGlB2B,GACN0B,KAAKC,uBAAuB1D,EAAQwD,MAAM1D,oCArBnCE,cACAC,aACAkB"}